<!DOCTYPE html>

<html>
<head>
     <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,300' rel='stylesheet' type='text/css'>
    <script src="https://use.typekit.net/hoy3lrg.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>

    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css'>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="{% static 'css/custom.css' %}" />
{#    <link rel="stylesheet" href="{% static 'css/room.css' %}">#}
  </head>

<body>
  <div id="frame">

    <div class="content" >
      <div class="contact-profile container-fluid">
        <img src="{% static 'img/chay.png' %}" alt="" />

        <p class="font-weight-bold text-info navbar-brand" style="margin-top: 10px">{{ user.username }}</p>



          <a  href="/logout"><button class="btn btn-info">Logout</button></a>

          <a  href="{% url 'index' %}"><button class="btn btn-outline-info">Rooms</button></a>

      </div>
    <div class="room_name">
        <p class="font-italic font-weight-bold text-info">{{ room_name }} </p>
    </div>
      <div class="messages">
        <ul id="chat-log">
       <li class="sent">
            <img src="{% static 'img/chay.png' %}" alt="" />
           <p>Welcome to my shitty chat app.<span id="spa" class="shit">Zuricha Developer</span></p>

          </li>
        </ul>
      </div>
    </div>
      <div>
          <p>Welcome to my shitty chat app.<span id="spa" class="shit">Zuricha Developer</span></p>
      </div>

          <div class="message-input panel-foot">

        <div class="col-sm-11 col-xs-11 ">
          <textarea class="form-control" rows="1" placeholder="Write your message..." id="chat-message-input"></textarea>
        </div>

        <button class="col-sm-1 col-xs-1 reply-send" id="chat-message-submit" onclick="{}">
          <i class="fa fa-send fa-2x" aria-hidden="true"></i>
        </button>
        <!-- <button id="chat-shit"></button> -->
      </div>
          </div>

    </div>
  </div>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">




{{ room_name|json_script:"room-name" }}
    <script src="{% static 'js/custom.js' %}"></script>
    <script src="{% static 'js/reconnecting-websocket.js' %}"></script>
    <script>
        const shortId = '9FMNN2Q92'
        const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwc2FtaSIsImV4cCI6MTY0MDQ2NzUyMX0.qGNE6OJT3hrZytG-NZP8bAnuCb1eL-jPPHK8Jqc0tZg';
        const username = "psami"
                
        var ws = null;
       
        // function connect(event) {
  
                
                ws = new WebSocket("ws://localhost:8000/ws/room/" + shortId + "?token=" + token);
                ws.onmessage = function(e) {
                
                    const data = JSON.parse(e.data)
                    console.log(data.message)
                    createMessage(data['message']);
                    event.preventDefault()
                };
                
            
        // document.querySelector('#chat-shit').onclick = function(e) {
        //     connect(e);
        //     event.preventDefault()}

            document.querySelector('#chat-message-submit').onclick = function(e) {
                console.log("click")
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            ws.send(JSON.stringify({
                "command": "new_message",
                'content': message, 
                'media_url': 'shii.com'
            }));
            messageInputDom.value = '';
            
            event.preventDefault()
        }

        function createMessage(data){
            const author = data['author'];
            const timestamp = data['timestamp'];
          const msgListTag = document.createElement('li');
          const imgTag = document.createElement('img');
          const pTag = document.createElement('p');
          const spanTag = document.createElement('span');
          spanTag.textContent = author + ' | ' +timestamp;
          spanTag.classList.add('shit');
          pTag.textContent = (data.content);
          pTag.appendChild(spanTag)
          imgTag.src = '';

          if (author === username) {
            msgListTag.className = 'replies';
          } else {
            msgListTag.className = 'sent';
          }
          msgListTag.appendChild(imgTag);
          msgListTag.appendChild(pTag);
          msgListTag.appendChild(spanTag);
          document.querySelector('#chat-log').appendChild(msgListTag);

        }
    </script>

</body>

</html>
